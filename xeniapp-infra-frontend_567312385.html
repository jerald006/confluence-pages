<!DOCTYPE html>
<html>
    <head>
        <title>XeniApp : xeniapp-infra-frontend</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">XeniApp</a></span>
                            </li>
                                                    <li>
                                <span><a href="XeniApp_542179373.html">XeniApp</a></span>
                            </li>
                                                    <li>
                                <span><a href="Technical-Documents---XeniApp_542181190.html">Technical Documents - XeniApp</a></span>
                            </li>
                                                    <li>
                                <span><a href="Environment-Setup---XeniApp_542180648.html">Environment Setup - XeniApp</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            XeniApp : xeniapp-infra-frontend
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Kavibritto Chalaman</span>, last modified on Jun 13, 2023
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="xeniapp-infra-frontend-DeploymentProcessDocumentation">Deployment Process Documentation</h1><h2 id="xeniapp-infra-frontend-TableofContents">Table of Contents</h2><ul><li><p><a href="#overview" rel="nofollow">Overview</a></p></li><li><p><a href="#prerequisites" rel="nofollow">Prerequisites</a></p></li><li><p><a href="#deployment-steps" rel="nofollow">Deployment Steps</a></p><ul><li><p><a href="#step-1-infrastructure-deployment" rel="nofollow">Step 1: Infrastructure Deployment</a></p></li><li><p><a href="#step-2-frontend-application-deployment" rel="nofollow">Step 2: Frontend Application Deployment</a></p></li></ul></li><li><p><a href="#troubleshooting" rel="nofollow">Troubleshooting</a></p></li></ul><h2 id="xeniapp-infra-frontend-Overview">Overview</h2><p>The deployment process documentation provides a comprehensive guide for deploying a multi-tenant system using AWS infrastructure and Terraform. This documentation covers the deployment steps for the main domain, booking site, and admin site.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/567312385/568459265.png" data-image-src="attachments/567312385/568459265.png" data-height="739" data-width="681" data-unresolved-comment-count="0" data-linked-resource-id="568459265" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="xeni-infra-frontend.drawio.png" data-base-url="https://xeni-workspace.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="567312385" data-linked-resource-container-version="3" data-media-id="aea8c13a-3416-4387-b4bf-0efc7991d7e1" data-media-type="file"></span><p /><h2 id="xeniapp-infra-frontend-Prerequisites">Prerequisites</h2><div class="table-wrap"><table data-layout="default" data-local-id="8ac23be3-de23-4d2a-95cf-53c37d07f488" class="confluenceTable"><colgroup><col style="width: 340.0px;"/><col style="width: 340.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p>Name</p></th><th class="confluenceTh"><p>Version</p></th></tr><tr><td class="confluenceTd"><p><a class="external-link" href="https://file+.vscode-resource.vscode-cdn.net/home/kavibritto/Desktop/xeniapp/infra/xeniapp-infra-frontend/README.md#requirement_terraform" rel="nofollow">terraform</a></p></td><td class="confluenceTd"><p>~&gt; 1.0.10</p></td></tr><tr><td class="confluenceTd"><p><a class="external-link" href="https://file+.vscode-resource.vscode-cdn.net/home/kavibritto/Desktop/xeniapp/infra/xeniapp-infra-frontend/README.md#requirement_aws" rel="nofollow">aws</a></p></td><td class="confluenceTd"><p>4.67.0</p></td></tr><tr><td class="confluenceTd"><p><a class="external-link" href="https://file+.vscode-resource.vscode-cdn.net/home/kavibritto/Desktop/xeniapp/infra/xeniapp-infra-frontend/README.md#requirement_random" rel="nofollow">random</a></p></td><td class="confluenceTd"><p>3.1.0</p></td></tr></tbody></table></div><h2 id="xeniapp-infra-frontend-DeploymentSteps">Deployment Steps</h2><h3 id="xeniapp-infra-frontend-Step1:InfrastructureDeployment">Step 1: Infrastructure Deployment</h3><p><strong>main domain:</strong></p><p>The  CloudFront distribution with multiple origins and behaviors. Here are the key points:</p><ul><li><p>The code uses local variables to determine if the environment is a production environment (<code>is_prod_env</code>) and sets the main domain name (<code>main_domain_name</code>) based on the environment.</p></li><li><p>Data blocks are used to retrieve information about the S3 bucket for the booking site (<code>booking_s3_bucket</code>), the S3 bucket for logos (<code>logo_s3_bucket</code>), and an Application Load Balancer (<code>blog_alb</code>).</p></li><li><p>An AWS CloudFront origin access identity (<code>cloudfront_main_oai</code>) is created to provide CloudFront access to the booking site.</p></li><li><p>The <code>aws_cloudfront_distribution</code> resource defines the CloudFront distribution for the root domain. It has multiple origins, including the Application Load Balancer and the S3 buckets for the booking site and logos.</p></li><li><p>The CloudFront distribution's configuration includes various settings such as SSL protocols, custom headers, caching behaviors, and cache control for different path patterns.</p></li><li><p>The configuration also specifies the SSL certificate using AWS Certificate Manager (ACM), geo-restriction settings, custom error responses, and an A-record in Route 53 to map the <code>www</code> subdomain to the CloudFront distribution.</p></li></ul><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/567312385/567377949.png" data-image-src="attachments/567312385/567377949.png" data-height="685" data-width="1574" data-unresolved-comment-count="0" data-linked-resource-id="567377949" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20230602-114706.png" data-base-url="https://xeni-workspace.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="567312385" data-linked-resource-container-version="3" data-media-id="917b62c5-5000-4452-bc7a-69b43faf12e7" data-media-type="file"></span><p /><p><strong>Booking and Admin Site</strong></p><p>The Terraform configuration that sets up infrastructure components including CloudFront, ACM (AWS Certificate Manager), Route53, and S3 buckets. Here are the key points:</p><ul><li><p>The <code>locals</code> block defines various local variables used throughout the configuration, including domain names, cache behaviors, origin groups, geo-restriction settings, custom error responses, custom headers, and more.</p></li><li><p>The <code>aws_cloudfront_origin_access_identity</code> resource creates a CloudFront origin access identity that allows CloudFront access to the specified resources.</p></li><li><p>The <code>module &quot;cloudfront&quot;</code> block configures the CloudFront distribution using the <code>terraform-aws-modules/cloudfront/aws</code> module. It sets up aliases, logging configuration, origins (including AppSync and S3 buckets), cache behaviors, SSL certificate, geo-restriction, and custom error responses.</p></li><li><p>The <code>data &quot;aws_route53_zone&quot; &quot;top_level_dns_zone&quot;</code> retrieves information about the Route53 DNS zone for the top-level domain.</p></li><li><p>The <code>module &quot;acm&quot;</code> block configures the ACM certificate using the <code>terraform-aws-modules/acm/aws</code> module. It specifies the domain name, zone ID, subject alternative names, and waits for the certificate validation.</p></li><li><p>The <code>resource &quot;aws_route53_record&quot;</code> blocks create Route53 records for the CloudFront distribution, mapping the domain suffix, customer domain prefixes, and wildcard subdomains to the CloudFront distribution.</p></li><li><p>The <code>module &quot;s3_one&quot;</code> block creates an S3 bucket using the <code>terraform-aws-modules/s3-bucket/aws</code> module. It sets various bucket properties, including access policies and versioning.</p></li><li><p>The <code>module &quot;log_bucket&quot;</code> block creates an S3 bucket for CloudFront logs using the same module as above. It grants necessary permissions to the bucket for the current user and the CloudFront log delivery.</p></li><li><p>The <code>data &quot;aws_iam_policy_document&quot; &quot;s3_policy&quot;</code> generates an IAM policy document granting CloudFront access to the S3 bucket created earlier.</p></li></ul><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/567312385/567377943.png" data-image-src="attachments/567312385/567377943.png" data-height="685" data-width="1574" data-unresolved-comment-count="0" data-linked-resource-id="567377943" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20230602-114630.png" data-base-url="https://xeni-workspace.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="567312385" data-linked-resource-container-version="3" data-media-id="27556759-8940-4e75-bbed-46c5365b8319" data-media-type="file"></span><p /><p><strong>Storefronts</strong></p><p>AWS resources such as CloudFront distributions, ACM certificates, Route 53 records, and S3 buckets used for this deployment. It creates a main CloudFront distribution and separate distributions for each storefront. Here are the key points:</p><ol start="1"><li><p>Local Variables: The code defines local variables, including the storefront domain name.</p></li><li><p>CloudFront Distribution: The &quot;cloudfront&quot; module provisions the main CloudFront distribution with various configuration settings such as aliases, comment, logging, origins, cache behaviors, viewer certificate, geo restriction, and custom error responses.</p></li><li><p>The main storefront domains are subdomains like store1,store2..etc. and under the main storefront we includes the client subdomains.</p></li><li><p>ACM Certificates: The &quot;storefront_acm&quot; module provisions ACM certificates for the main CloudFront distribution and each storefront. we asked to clients to validate the domain ownership using dns records.</p></li><li><p>Route 53 Records: The &quot;aws_route53_record&quot; resource creates A records that point to the main CloudFront distribution and each storefront distribution.</p></li><li><p>S3 Bucket for CloudFront Logs: The &quot;storefront_log_bucket&quot; module provisions an S3 bucket for storing CloudFront logs.</p></li><li><p>S3 Bucket for Origin: The &quot;s3_one&quot; module provisions an S3 bucket for the main CloudFront distribution's origin. it directly points to the booking S3 bucket.</p></li><li><p>IAM Policy and Origin Access Identity: The code defines an IAM policy and provisions an AWS CloudFront origin access identity.</p></li></ol><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/567312385/567312398.png" data-image-src="attachments/567312385/567312398.png" data-height="486" data-width="1109" data-unresolved-comment-count="0" data-linked-resource-id="567312398" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20230602-114507.png" data-base-url="https://xeni-workspace.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="567312385" data-linked-resource-container-version="3" data-media-id="bb15a439-5ce4-4f14-91ea-c793b22d37b6" data-media-type="file"></span><p /><h3 id="xeniapp-infra-frontend-Step2:FrontendApplicationDeployment">Step 2: Frontend Application Deployment</h3><p>The &quot;Build and Deploy to Cloudfront&quot; CI/CD process is designed to automate the build and deployment of an application to AWS Cloudfront. This process ensures that the latest changes in the codebase are built, packaged, and deployed to the specified Cloudfront distribution. The process is triggered on specific branches and tags and follows a series of steps to achieve the desired deployment.</p><h3 id="xeniapp-infra-frontend-Workflow">Workflow</h3><p>The workflow of the &quot;Build and Deploy to Cloudfront&quot; CI/CD process is as follows:</p><ol start="1"><li><p><strong>Initialization</strong></p><ul><li><p>This step sets up the environment for the deployment process.</p></li><li><p>It runs on an Ubuntu environment and defines the necessary outputs for subsequent steps.</p></li><li><p>The <code>XENIENV_NAME</code> variable is determined based on the branch or tag name.</p></li><li><p>The <code>APP_NAME</code> and <code>S3-BUCKET</code> variables are set.</p></li><li><p>The <code>SOURCE_DIR</code>, <code>DEPLOY-GROUP</code>, <code>DEPLOYMENT-REQUIRED</code>, and <code>NOTIFICATION-REQUIRED</code> variables are also set.</p></li></ul></li><li><p><strong>Upload</strong></p><ul><li><p>This step is triggered after the initialization step.</p></li><li><p>It runs on an Ubuntu 20.04 environment and requires the initialization step to be completed successfully.</p></li><li><p>The deployment is only performed if <code>DEPLOYMENT-REQUIRED</code> is set to 'true'.</p></li><li><p>The necessary packages are installed using Node.js and NPM.</p></li><li><p>The application is built by running the build command specified in the code.</p></li><li><p>A <code>versioninfo.json</code> file is generated, containing information about the branch, commit, version, environment, and application name.</p></li><li><p>AWS credentials are configured to interact with AWS services.</p></li><li><p>The built application files are synchronized to an S3 bucket, making them publicly readable.</p></li><li><p>Cloudfront is invalidated to update the distribution with the latest changes.</p></li><li><p>Slack notifications are sent for QA, Prod, and UAT deployments.</p></li><li><p>Release information is published to Sentry for error tracking and monitoring purposes.</p></li></ul></li></ol><h3 id="xeniapp-infra-frontend-Usage">Usage</h3><p>To utilize the &quot;Build and Deploy to Cloudfront&quot; CI/CD process, follow these steps:</p><ol start="1"><li><p>Ensure that the repository contains the necessary AWS credentials and Slack notification URLs as secrets.</p></li><li><p>Verify that the required environment-specific configuration files are present in the repository.</p></li><li><p>Push commits or create tags on the specified branches (<code>develop</code>, <code>feature-*</code>, <code>release-*</code>, <code>main</code>) to trigger the CI/CD process.</p></li><li><p>The initialization step will automatically determine the environment variables based on the branch or tag name.</p></li><li><p>If <code>DEPLOYMENT-REQUIRED</code> is set to 'true', the application will be built and deployed to Cloudfront.</p></li><li><p>Slack notifications will be sent for QA, Prod, and UAT deployments, as defined in the process.</p></li><li><p>Release information will be published to Sentry for error tracking and monitoring purposes.</p></li></ol><p><strong>Note:</strong> Ensure that all necessary dependencies, environment variables, and deployment configurations are properly set up to achieve successful and reliable deployments.</p><h2 id="xeniapp-infra-frontend-Troubleshooting">Troubleshooting</h2><p>you can start looking terraform code and make changes to troubleshoot the issue.</p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/567312385/567312398.png">image-20230602-114507.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/567312385/567377943.png">image-20230602-114630.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/567312385/567377949.png">image-20230602-114706.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/567312385/568459265.png">xeni-infra-frontend.drawio.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jun 24, 2024 05:28</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
